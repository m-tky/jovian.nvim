# jovian.nvim

**jovian.nvim** is a Neovim plugin designed to provide a Jupyter-like experience for editing Python files, specifically those using the "percent" format (`# %%`). It allows you to execute code cells, view markdown previews, monitor variables, and control the Jupyter kernel directly from Neovim.

## ‚ú® Features

- **Code Cell Execution**: Run individual cells or the entire file.
- **Result Preview**:
    - Automatically displays the rendered output of the **current cell** under the cursor.
    - Supports live updates as you navigate through your file.
    - Displays text output and images (plots) generated by code cells.
- **Variables Pane**: Monitor active variables in a dedicated pane.
- **Kernel Control**: Start, restart, and interrupt the Python kernel.
- **Cell Management**: Move, delete, split, and merge cells easily.
- **Virtual Text Status**: Visual indicators for cell status (`Running`, `Done`, `Error`).
- **Kernel Selection**: Switch between local and remote (SSH) Python kernels dynamically.
- **Remote Execution**: Seamlessly execute code on remote servers via SSH, with local result preview and variable monitoring.
- **Interleaved Output**: REPL output is interleaved with code execution for a natural flow.
- **Cell Navigation**: Quickly jump between cells using a fuzzy finder (`:JovianCells`), with support for searching code content within cells.
- **Magic Command Support**: Syntax highlighting and error suppression for IPython magic commands (`%timeit`, `!ls`, etc.).

## üì¶ Dependencies

### Required
### Required
- **Python Environment**: You need `ipykernel` and `jupyter_client` installed (both locally and on remote hosts).
  ```bash
  pip install ipykernel jupyter_client
  ```

### Recommended
- **System Notification** (Optional, for desktop notifications):
    - **Linux**: `libnotify` (provides `notify-send`).
    - **macOS**: `osascript` (usually pre-installed).
- **[jupytext.nvim](https://github.com/GCBallesteros/jupytext.nvim)**: Highly recommended for seamless conversion between `.ipynb` files and the percent-formatted python files (`.py`) used by this plugin. It allows you to open `.ipynb` files directly as `.py` files in Neovim.
- **[snacks.nvim](https://github.com/folke/snacks.nvim)**: Required for the `:JovianCells` picker functionality.

### Important (For Image Support)
- **[image.nvim](https://github.com/3rd/image.nvim)**: Required for displaying plots and images within Neovim.

**Example configure `image.nvim` as follows:**

```lua
require("image").setup({
    backend = "kitty", -- it depends on your environment (e.g., "ueberzug")
    processor = "magick_cli", -- it depends on your environment
    max_width_window_percentage = 100,
    max_height_window_percentage = 30,
    window_overlap_clear_enabled = true,
})
```

## ‚ö° Try it with Nix (No Installation Required)

If you have [Nix](https://nixos.org/) installed, you can try `jovian.nvim` immediately without installing it or cloning the repository. This will drop you into a pre-configured shell with Neovim, Python dependencies, and the plugin ready to go.

> [!NOTE]
> This trial environment is configured to use the **Kitty** terminal backend for image rendering. Please run this inside a [Kitty](https://sw.kovidgoyal.net/kitty/) terminal.

```bash
nix develop github:m-tky/jovian.nvim
# Inside the shell:
nvim-jovian demo_jovian.py
```

## ‚ö° Quickstart

Using [lazy.nvim](https://github.com/folke/lazy.nvim):

```lua
{
    "jovian-org/jovian.nvim",
    dependencies = {
        "3rd/image.nvim", -- Required for image/plot support
        "GCBallesteros/jupytext.nvim", -- Recommended for .ipynb conversion
        {
            "folke/snacks.nvim",
            opts = {
                picker = { enabled = true },
            },
        },
    },
    config = function()
        -- Configure image.nvim (Required for plots)
        -- Please refer to the image.nvim documentation for detailed configuration options.
        require("image").setup({
            backend = "kitty", -- Or "ueberzug" depending on your terminal emulator
            processor = "magick_cli", -- Or "magick_rock"
            max_width_window_percentage = 100,
            max_height_window_percentage = 30,
            window_overlap_clear_enabled = true,
        })

        require("jovian").setup({
            python_interpreter = "python3", -- Specify your python path or venv
        })
    end
}
```

## ‚öôÔ∏è Configuration

You can configure `jovian.nvim` by passing a table to the `setup` function.

```lua
require("jovian").setup({
    -- UI Settings
    -- UI Layouts (Flexible Window Management)
    ui = {
        layouts = {
            {
                elements = {
                    { id = "preview", size = 0.75 },
                    { id = "pin", size = 0.25 },
                },
                position = "right",
                size = 0.25,
            },
            {
                elements = {
                    { id = "output", size = 0.65 },
                    { id = "variables", size = 0.35 },
                },
                position = "bottom",
                size = 0.25,
            }
        }
    },

    -- UI Symbols (Virtual Text)
    ui_symbols = {
        running = "Ôì£ Running...",
        done = "Ó™≤ Done",
        error = "‚úò Error",
        interrupted = "ÓÆ• Interrupted",
    },

    -- Visuals
    flash_highlight_group = "Visual",
    flash_duration = 300,
    float_border = "rounded",

    -- Python
    python_interpreter = "python3",

    -- Behavior
    notify_threshold = 10,
    notify_mode = "all", -- "all", "error", "none"
    plot_view_mode = "inline", -- "inline", "window"

    -- Magic Commands
    suppress_magic_command_errors = true, -- Suppress LSP errors for magic commands

    -- TreeSitter
    treesitter = {
        markdown_injection = true, -- Highlight markdown cells
        magic_command_highlight = true, -- Highlight magic commands
    },
})
```

## üìÅ Caching & Git

`jovian.nvim` creates a hidden directory named `.jovian_cache` in **the same directory as the file you are editing**. This directory stores intermediate files and metadata.

**Automatic Cleanup**: The plugin automatically removes cache directories for files that no longer exist when you open or close Neovim. You can also trigger this manually with `:JovianClean!`.

**Recommendation**: Add this directory to your `.gitignore` (globally or per-project) to keep your repository clean.

```gitignore
**/.jovian_cache
```

### Key Options
- **`ui.layouts`**: Define the window layout. You can configure multiple split areas (right, bottom, left, top) and the elements within them (preview, output, variables, pin).
- **`ui_symbols`**: Customize the text/icons displayed for cell status.
- **`python_interpreter`**: Defaults to `"python3"`. This works seamlessly with virtual environments.

## üöÄ Commands

### Host Management (SSH & Local)
- **`:JovianAddHost [name] [ssh_host] [python_path]`**: Add a remote SSH host configuration.
- **`:JovianAddLocal [name] [python_path]`**: Add a local Python configuration.
- **`:JovianUse [name]`**: Switch to a specific host configuration.
- **`:JovianRemoveHost [name]`**: Remove a host configuration.

**Note**: If arguments are omitted, these commands will prompt you interactively.

### UI & Layout
- **`:JovianOpen`**: Open the Jovian UI (REPL, Preview, and optionally Vars Pane).
- **`:JovianToggle`**: Toggle the visibility of the Jovian UI.
- **`:JovianClearREPL`**: Clear the REPL output.
- **`:JovianToggleVars`**: Manually toggle the Variables Pane.
- **`:JovianTogglePlot`**: Toggle between inline and window plot view modes. In window mode, plots are displayed in an external window (via TkAgg) while still being captured for the preview pane.

### Execution
- **`:JovianRun`**: Run the current cell.
- **`:JovianRunAndNext`**: Run the current cell and move to the next one.
- **`:JovianRunAll`**: Run all cells in the file.
- **`:JovianRunAbove`**: Run all cells from the beginning of the file up to and including the current cell.
- **`:JovianRunLine`**: Run the current line.
- **`:JovianSendSelection`**: Run the visually selected code.

### Kernel Control
- **`:JovianStart`**: Start the kernel manually.
- **`:JovianRestart`**: Restart the kernel.
- **`:JovianInterrupt`**: Interrupt the current execution.

### Cell Management
- **`:JovianNextCell` / `:JovianPrevCell`**: Navigate between cells.
- **`:JovianNewCellAbove` / `:JovianNewCellBelow`**: Insert a new cell.
- **`:JovianNewMarkdownCellBelow`**: Insert a new markdown cell below.
- **`:JovianDeleteCell`**: Delete the current cell.
- **`:JovianMoveCellUp` / `:JovianMoveCellDown`**: Move the current cell up or down.
- **`:JovianMergeBelow`**: Merge the current cell with the one below.
- **`:JovianSplitCell`**: Split the current cell at the cursor.
- **`:JovianCells`**: Open a fuzzy picker to list and search cells. Supports searching by cell title or code content (e.g., function definitions, variables).

### Data & Inspection
- **`:JovianVars`**: Show variables in a floating window (forces float even if pane is open).
- **`:JovianView [df]`**: View a pandas DataFrame or variable in a floating window.
- **`:JovianCopy [var]`**: Copy a variable's value to the clipboard.
- **`:JovianDoc [obj]`**: Inspect an object (docstring, definition).
- **`:JovianPeek [obj]`**: Peek at an object's value/info.
- **`:JovianProfile`**: Run the current cell with profiling enabled.
- **`:JovianBackend`**: Print the current Matplotlib backend to the REPL.
- **`:JovianClean`**: Clean stale caches for the current buffer. Use `:JovianClean!` to also remove orphaned caches globally.
- **`:JovianClearCache`**: Clear cache for the current cell. Use `:JovianClearCache!` to clear cache for all cells in the current buffer.
- **`:JovianClearDiag`**: Clear diagnostics from the current buffer.

## üñ•Ô∏è UI Layout

The Jovian UI is designed to maximize coding efficiency:

1.  **REPL Window**: Opens at the bottom of the screen (`belowright split`).
2.  **Preview Window**: Opens to the right (`vsplit`), displaying rendered output.
3.  **Variables Pane**: Opens as a **vertical split to the right of the REPL**. This allows you to keep an eye on your data without obscuring your code or output.

### Virtual Text Status
Cells display their execution status using virtual text on the header line (`# %%`):
- **Running**: Indicates the cell is currently executing.
- **Done**: Indicates execution completed successfully. (e.g., `Done (14:30:05)`)
- **Error**: Indicates an error occurred.

**Stability**: The virtual text system is robust and handles **Undo/Redo** operations gracefully. If you move or delete cells and then undo, the status indicators will be correctly restored or cleared.

## üôè Acknowledgements

This plugin is heavily inspired by **[vim-jukit](https://github.com/luk400/vim-jukit)**. I am grateful for the following concepts and implementations that served as a reference:

- **Architecture**: The core design of separating the Neovim frontend from a Python backend that manages the IPython kernel.
- **Output Capture**: The technique of monkey-patching `sys.stdout` and `sys.stderr` to capture and redirect execution output back to Neovim.
- **UI Layout**: The effective split-window arrangement for code, REPL, and plot previews.
- **Caching Structure**: The fundamental approach to managing execution artifacts and persistent caching (which now includes remote host integration).
- **Remote Execution**: The concept of bridging local Neovim with a remote Python kernel via SSH.